<project><!-- CACHE ID 4aa4ec7e-b4fe-4b14-bc71-ddd7dcdd66ac -->
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
     <xs:schema targetNamespace="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      	   <xs:simpleType name="file">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>  
     </xs:schema>	 
  </types>
  <global name="swift#string#17000">
    <vdl:new type="string" value="hello" />
  </global>
  <global name="swift#string#17002">
    <vdl:new type="string" value="how are you" />
  </global>
  <global name="swift#string#17001">
    <vdl:new type="string" value="hi there" />
  </global>
  <element name="echo" arguments="f,s">
    <parameterlog>
    <string>input</string>
    <string>s</string>
    <vdl:getdatasetprovenanceid var="{s}" />
    <string>{#thread}</string>
    </parameterlog>
    <parameterlog>
    <string>output</string>
    <string>f</string>
    <vdl:getdatasetprovenanceid var="{f}" />
    <string>{#thread}</string>
    </parameterlog>
    <log level="debug" message="PROCEDURE line=4 thread={#thread} name=echo"/>
    <vdl:execute>
      <vdl:tr>echo</vdl:tr>
      <vdl:stagein var="{s}"/>
      <vdl:stageout var="{f}"/>
      <vdl:arguments>
        <variable>s</variable>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename>
         <variable>f</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{f}"/>
    <log level="debug" message="PROCEDURE_END line=4"/></element>

  <element name="echo_batch" arguments="fa,sa">
    <parameterlog>
    <string>input</string>
    <string>sa</string>
    <vdl:getdatasetprovenanceid var="{sa}" />
    <string>{#thread}</string>
    </parameterlog>
    <parameterlog>
    <string>output</string>
    <string>fa</string>
    <vdl:getdatasetprovenanceid var="{fa}" />
    <string>{#thread}</string>
    </parameterlog>
    <log level="info"><string>STARTCOMPOUND thread={#thread} name=echo_batch</string></log>
    <sequentialWithID>
        <sequential>
          <vdl:tparallelFor name="$">
            <getarrayiterator><variable>sa</variable></getarrayiterator>
            <set names="$$, s">
              <each items="{$}"/>
            </set>
              <set name="i">
                <vdl:new type="int" value="{$$}"/>
              </set>	<log level="debug" message="FOREACH_IT_START line=11 thread={#thread}"/>
          <log level="debug"><string>SCOPE thread={#thread}</string></log>

                <sequentialWithID>
                    <sequential>
                      <echo>
                        <parallel>
                          <vdl:getfieldsubscript>
                            <argument name="var"><variable>fa</variable></argument>
                            <argument name="subscript"><variable>i</variable></argument>
                          </vdl:getfieldsubscript>
                          <variable>s</variable>
                        </parallel>
                      </echo>
                    </sequential>
                </sequentialWithID>
              <log level="debug" message="FOREACH_IT_END line=11 thread={#thread}"/>
          </vdl:tparallelFor>
        </sequential>
    </sequentialWithID><vdl:closedataset var="{fa}"/>
    <log level="info"><string>ENDCOMPOUND thread={#thread}</string></log></element>

  <set name="sa">
    <vdl:new type="string[]" dbgname="sa" waitfor="88002">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">sa-85ab3f7f-5c43-470b-a33c-bf5a19d4079f</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
  <parameterlog>
  <string>intermediate</string>
  <string>sa</string>
  <vdl:getdatasetprovenanceid var="{sa}" />
  <string>{#thread}</string>
  </parameterlog>
  <set name="fa">
    <vdl:new type="file[]" dbgname="fa" waitfor="88003">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix">fa-c862eccb-6ea8-4c8b-9976-efd6d3ea66da</vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
  <parameterlog>
  <string>intermediate</string>
  <string>fa</string>
  <vdl:getdatasetprovenanceid var="{fa}" />
  <string>{#thread}</string>
  </parameterlog>
  <restartLog>
  	<vdl:mains>
		<vdl:startprogressticker />
		<vdl:mainp>
		    <parallel>
		        <sequential>
		             <vdl:setfieldvalue>
		               <argument name="var">
		                 <variable>sa</variable>
		               </argument>
		               <argument name="value">
		                 <vdl:createarray>
		                   <list>
		                     <variable>swift#string#17000</variable>
		                     <variable>swift#string#17001</variable>
		                     <variable>swift#string#17002</variable>
		                   </list>
		                 </vdl:createarray>
		               </argument>
		             </vdl:setfieldvalue>
		            <partialCloseDataset var="{sa}" closeID="88002" />
		        </sequential>
		        <sequential>
		          <echo_batch>
		            <parallel>
		              <variable>fa</variable>
		              <variable>sa</variable>
		            </parallel>
		          </echo_batch>
		            <partialCloseDataset var="{fa}" closeID="88003" />
		        </sequential>
		    </parallel>
		</vdl:mainp>
		<vdl:stopprogressticker />
	</vdl:mains>
  </restartLog>  
</project>
